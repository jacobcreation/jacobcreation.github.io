<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PoliteBot Chat</title>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 20px;
    transition: background 0.3s, color 0.3s;
    background: #f0f0f5;
    color: #000;
  }
  body.dark { background: #121212; color: #f0f0f0; }
  #container {
    width: 500px;
    height: 600px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: background 0.3s, color 0.3s;
  }
  body.dark #container { background: #1e1e1e; }
  #chatBox {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 15px;
    white-space: pre-wrap;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #typingIndicator {
    padding: 8px;
    font-size: 14px;
    color: gray;
    display: none;
    margin-left: 10px;
    font-style: italic;
  }
  .message {
    display: flex;
    align-items: flex-end;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeIn 0.3s forwards;
  }
  @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
  .message.you { justify-content: flex-end; }
  .bubble {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 15px;
    line-height: 1.3;
  }
  .you .bubble {
    background: #1a4bbb;
    color: white;
    border-bottom-right-radius: 0;
  }
  .bot .bubble {
    background: #0b7a00;
    color: white;
    border-bottom-left-radius: 0;
  }
  .bounce { animation: bounce 0.5s; }
  @keyframes bounce { 0% { transform: translateY(0);} 50% { transform: translateY(-10px);} 100% { transform: translateY(0);} }
  #bottom {
    padding: 10px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    background: #f4f4f6;
  }
  body.dark #bottom { background: #2c2c2c; }
  #inputBox { flex: 1; padding: 6px; font-size: 15px; }
  #sendButton, #commandsButton, #darkToggle, #clearButton, #forgetButton, #upgradeButton {
    width: 110px;
    font-size: 15px;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="container">
  <div id="chatBox"></div>
  <div id="typingIndicator">PoliteBot is typingâ€¦</div>
  <div id="bottom">
    <input id="inputBox" type="text" placeholder="Type a message...">
    <button id="sendButton">Send</button>
    <button id="commandsButton">Commands</button>
    <button id="darkToggle">ğŸŒ™</button>
    <button id="clearButton">Clear</button>
    <button id="forgetButton">Forget</button>
    <button id="upgradeButton">Needs Upgrades</button>
  </div>
</div>

<script>
let memory = JSON.parse(localStorage.getItem('politebotMemory') || '[]');
memory.pendingFact = null;
let quizActive = false;
let quizCurrent = null;
let quizScore = parseInt(localStorage.getItem('politebotScore')||'0');

const numberWords = {
  "zero":0,"one":1,"two":2,"three":3,"four":4,"five":5,
  "six":6,"seven":7,"eight":8,"nine":9,"ten":10
};

const funFacts = [
  "Octopuses have three hearts.",
  "A group of flamingos is called a 'flamboyance'.",
  "Wombat poop is cube-shaped.",
  "A cloud can weigh more than a million pounds.",
  "Bananas are berries, but strawberries are not."
];

const memeReactions = [
  "Bro is COOKING ğŸ”¥ğŸ”¥ğŸ”¥",
  "No cap thatâ€™s actually wild ğŸ˜­",
  "Skibidi facts fr ğŸ¤",
  "Bro got that W rizz ğŸ˜",
  "Ohio behavior ğŸ’€ (jk lol)",
  "Sigma move tbh ğŸ˜ˆ",
  "NPC moment ğŸ’€",
  "Fanum tax took that one fr ğŸ˜­",
  "Goofy ahh energy detected ğŸ˜­ğŸ‘",
  "GYATTT ğŸ˜‚",
  "Bro dropped a whole meme bomb ğŸ’£ğŸ˜‚",
  "Real Gigachad energy ğŸ’ªğŸ˜¤"
];

const knowledge = {
  "capital of france": "Paris ğŸ‡«ğŸ‡·",
  "largest planet": "Jupiter ğŸª",
  "fastest land animal": "Cheetah ğŸ†",
  "hello": "Hi there! ğŸ˜„"
};

// Convert number words to digits
function wordsToNumbers(expr){
  for(let word in numberWords){
    let regex = new RegExp("\\b"+word+"\\b","gi");
    expr = expr.replace(regex, numberWords[word]);
  }
  return expr;
}

// Normalize math expressions
function normalizeMathExpression(expr){
  expr = expr.toLowerCase();
  expr = expr.replace(/plus/g,"+")
             .replace(/minus/g,"-")
             .replace(/times|x|Ã—/g,"*")
             .replace(/divided by/g,"/");
  expr = wordsToNumbers(expr);
  return expr;
}

// Safe math evaluation with correct order of operations
function safeMathEvaluate(expr){
  expr = normalizeMathExpression(expr);
  if(!/^[0-9+\-*/^().\s]+$/.test(expr)) return null;
  try {
    let result = Function('"use strict"; return ('+expr+')')();
    return (typeof result==="number" && isFinite(result)) ? result : null;
  } catch { return null; }
}

function maybeFact() { 
  return Math.random() < 0.25 ? funFacts[Math.floor(Math.random()*funFacts.length)] : null; 
}

function chatLogic(userInput){
  let trimmed = userInput.trim();
  let response="", emotion="ğŸ˜„";

  // Quiz answer handling
  if(quizActive && quizCurrent){
      let answer = trimmed.toLowerCase();
      let correctKeywords = quizCurrent.keywords;
      let correct = correctKeywords.some(k=>answer.includes(k.toLowerCase()));
      if(correct){
          quizScore += 1;
          localStorage.setItem('politebotScore', quizScore);
          quizActive = false;
          quizCurrent = null;
          return {response:`Correct! ğŸ‰ Your score: ${quizScore} points.`, emotion:"ğŸ˜"};
      } else {
          if(!quizCurrent.retry){
              quizCurrent.retry = true;
              return {response:`Hmm, not quite ğŸ˜… Hint: try something about "${correctKeywords[0]}"`, emotion:"ğŸ¤”"};
          } else {
              quizActive = false;
              let answerKeywords = correctKeywords.join(", ");
              quizCurrent = null;
              return {response:`Still not correct ğŸ˜­ The correct answer included: ${answerKeywords}. Score: ${quizScore}`, emotion:"ğŸ˜¢"};
          }
      }
  }

  // Pending fact from "did u know"
  if(memory.pendingFact){
      let factDescription = trimmed;
      memory.push(new Date().toISOString().slice(0,10)+": "+memory.pendingFact+" â€“ "+factDescription);
      localStorage.setItem('politebotMemory', JSON.stringify(memory));
      let learnedFact = memory.pendingFact;
      memory.pendingFact = null;
      return {response:`Bet! I learned something new about ${learnedFact} ğŸ˜ğŸ§ `, emotion:"ğŸ˜„"};
  }

  // Meme keywords
  const memeWords = ["skibidi","rizz","sigma","ohio","fanum","npc","goofy","gyatt","cap","no cap","bro","goofy ahh"];
  for(let w of memeWords){ if(trimmed.toLowerCase().includes(w)){ return {response:memeReactions[Math.floor(Math.random()*memeReactions.length)], emotion:"ğŸ”¥"}; } }

  // Math evaluation
  const mathResult = safeMathEvaluate(trimmed);
  if(mathResult!==null) return {response:`The answer is **${mathResult}** ğŸ§ `, emotion:"ğŸ˜"};

  // Exit
  if(/^(exit|quit|bye)$/i.test(trimmed)) return {response:"Aight bye bestie ğŸ‘‹ğŸ˜„", emotion:"ğŸ˜Š"};

  // Remember that
  if(trimmed.toLowerCase().startsWith("remember that")){
    let fact = trimmed.substring(13).trim();
    memory.push(new Date().toISOString().slice(0,10)+": "+fact);
    localStorage.setItem('politebotMemory', JSON.stringify(memory));
    return {response:"Bet, Iâ€™ll remember that ğŸ˜", emotion:"ğŸ˜„"};
  }

  // Name detection
  let namePattern = /\b(?:my name is|i['â€™]?m|im|call me)\s+([a-zA-Z]+)/i;
  let nameMatch = trimmed.match(namePattern);
  if(nameMatch){
    let name = nameMatch[1];
    memory.push(`${new Date().toISOString().slice(0,10)}: User's name is ${name}`);
    localStorage.setItem('politebotMemory', JSON.stringify(memory));
    return {response:`Yo ${name}! W name ğŸ˜„ğŸ”¥`, emotion:"ğŸ˜„"};
  }

  // Feeling detection
  let feelPattern = /\b(i feel|feeling|feels|i['â€™]?m feeling|im feeling|i am)\s+(.+)/i;
  let feelMatch = trimmed.match(feelPattern);
  if(feelMatch){
    let feeling = feelMatch[2];
    memory.push(`${new Date().toISOString().slice(0,10)}: User felt ${feeling}`);
    localStorage.setItem('politebotMemory', JSON.stringify(memory));
    return {response:`Gotchu, you feelinâ€™ ${feeling}? Valid tbh ğŸ˜„`, emotion:"ğŸ˜Š"};
  }

  // Small messages
  if(trimmed.length<3) return {response:"Bro typed the smallest message ever ğŸ˜­ whatâ€™s up?", emotion:"ğŸ˜„"};

  // Knowledge
  for(let q in knowledge){ if(trimmed.toLowerCase().includes(q)){ return {response: knowledge[q], emotion:"ğŸ˜"}; } }

  // Hi/Hello
  if(/^(hi|hello|hey|yo|sup)/i.test(trimmed)){
    return {response:["Yo! ğŸ˜","Hey bestie ğŸ‘‹","Wassup ğŸ˜„","Hiiiii ğŸ˜"][Math.floor(Math.random()*4)], emotion:"ğŸ˜Š"};
  }

  // Did u know learning
  if(trimmed.toLowerCase().startsWith("did u know")){
      let fact = trimmed.substring(10).trim();
      if(memory.some(m=>m.includes(fact))){
          return {response:"Haha yep, I already knew that ğŸ˜", emotion:"ğŸ˜„"};
      } else {
          memory.pendingFact = fact;
          return {response:"Ooh! I donâ€™t know that! Tell me about it! ğŸ¤“", emotion:"ğŸ¤”"};
      }
  }

  // Quiz command
  if(trimmed.toLowerCase()==="/quiz"){
      let learnedFacts = memory.filter(m => !m.includes("User's name") && !m.includes("User felt"));
      if(learnedFacts.length===0) return {response:"I havenâ€™t learned anything to quiz you on yet ğŸ˜­", emotion:"ğŸ˜¢"};
      let factLine = learnedFacts[Math.floor(Math.random()*learnedFacts.length)];
      let factParts = factLine.split("â€“");
      let question = factParts[0].split(":")[1] || factParts[0];
      let answerKeywords = factParts[1] ? factParts[1].trim().split(" ") : question.split(" ").slice(0,3);
      quizActive = true;
      quizCurrent = {question, keywords: answerKeywords, retry:false};
      return {response:`Quick quiz! Tell me about this:\n"${question}"`, emotion:"ğŸ¤”"};
  }

  // Questions
  if(trimmed.endsWith("?")) return {response:"Good question ngl ğŸ¤” what do *you* think?", emotion:"ğŸ¤”"};

  // Generic response
  let generic = [
    "Real talk? Thatâ€™s kinda fire ğŸ”¥",
    "Valid take tbh ğŸ˜„",
    "Bro I feel that ğŸ˜­",
    "Interesting, tell me more ğŸ‘€",
    "Okay thatâ€™s lowkey cool ğŸ˜",
    "Not gonna lie thatâ€™s a W ğŸ‘"
  ];
  response = generic[Math.floor(Math.random()*generic.length)];
  let fact = maybeFact(); if(fact) response += " Also fun fact: " + fact;
  return {response, emotion};
}

// UI
const chatBox = document.getElementById("chatBox");
const typingIndicator = document.getElementById("typingIndicator");
const inputBox = document.getElementById("inputBox");
const sendButton = document.getElementById("sendButton");
const commandsButton = document.getElementById("commandsButton");
const darkToggle = document.getElementById("darkToggle");
const clearButton = document.getElementById("clearButton");
const forgetButton = document.getElementById("forgetButton");
const upgradeButton = document.getElementById("upgradeButton");

function appendMessage(who,msg,emotion="ğŸ˜„"){
  let div = document.createElement("div");
  div.classList.add("message",who);
  let bubble = document.createElement("div");
  bubble.classList.add("bubble");
  bubble.innerHTML = who==="bot"? msg + " " + emotion : msg;
  if(who==="bot") bubble.classList.add("bounce");
  div.appendChild(bubble);
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showTyping(){ typingIndicator.style.display="block"; }
function hideTyping(){ typingIndicator.style.display="none"; }

function botRespondSlowly(text, emotion){
  showTyping();
  setTimeout(()=>{ hideTyping(); appendMessage("bot",text,emotion); },400+Math.random()*600);
}

// Events
sendButton.onclick = ()=>{ 
  let text = inputBox.value.trim(); 
  if(text==="") return; 
  appendMessage("you",text); 
  let {response, emotion} = chatLogic(text); 
  botRespondSlowly(response, emotion); 
  inputBox.value="";
};

inputBox.addEventListener("keydown",e=>{ if(e.key==="Enter"){ e.preventDefault(); sendButton.click(); } });

// Commands button shows temporary command list
commandsButton.onclick = ()=>{
  const commands = [
    "/fact", "/joke", "/meme", "/dice", "/coin", "/memory", "/time", "/quiz"
  ].join("\n");
  appendMessage("bot", "Commands:\n"+commands, "ğŸ˜„");
  setTimeout(()=>{ 
      let last = chatBox.lastChild; 
      if(last) chatBox.removeChild(last);
  },5000);
};

darkToggle.onclick = ()=> document.body.classList.toggle("dark");
clearButton.onclick = ()=>{ chatBox.innerHTML=""; botRespondSlowly("Chat cleared ğŸ‘ memories safe.","ğŸ˜„"); };
forgetButton.onclick = ()=>{ chatBox.innerHTML=""; memory=[]; localStorage.removeItem('politebotMemory'); quizScore=0; localStorage.removeItem('politebotScore'); botRespondSlowly("Aight I forgot everything ğŸ˜„ start fresh!", "ğŸ˜„"); };
upgradeButton.onclick = ()=>{ botRespondSlowly("Please send messages to jacobcreation on GitHub! ğŸ˜„", "ğŸ“¢"); };

// Initial greeting
appendMessage("bot","Yo! Iâ€™m PoliteBot ğŸ˜ Drop a meme, math problem, or press Commands!", "ğŸ˜„");
</script>
</body>
</html>
