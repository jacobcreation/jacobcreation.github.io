<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PGN Viewer — Arrows & Annotations</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/css/chessboard.min.css" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  padding: 10px;
  background: #f4f8fb;
  font-family: Arial, sans-serif;
}

.app {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  max-width: 1200px;
  margin: auto;
}

#left {
  flex: 1;
  min-width: 320px;
}

#right {
  width: 340px;
}

#dropZone {
  border: 2px dashed #1572A1;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  background: #e9f7ff;
  font-weight: bold;
  cursor: pointer;
}

#boardContainer {
  position: relative;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
}

#board {
  width: 420px;
  max-width: 100%;
}

#overlayCanvas {
  position: absolute;
  left: 10px;
  top: 10px;
  pointer-events: none;
}

textarea { width: 100%; padding: 8px; border-radius: 6px; }

.move-row {
  padding: 6px;
  cursor: pointer;
  border-radius: 5px;
}
.move-row:hover { background: #eef9ff; }
.move-row.active { background: #d8efff; border-left: 4px solid #1572A1; }

button {
  padding: 8px 12px;
  margin: 3px;
  border-radius: 6px;
  border: 1px solid #1572A1;
  background: #fff;
  cursor: pointer;
}
button:hover { background: #e1f3ff; }
</style>
</head>
<body>

<div class="app">

<div id="left">

  <h2>PGN Viewer — Arrows & Annotations</h2>

  <div id="dropZone">Click to upload a PGN file</div>
  <input type="file" id="fileInput" accept=".pgn" style="display:none">

  <textarea id="pgnInput" placeholder="Paste PGN here"></textarea>

  <button id="loadPgn">Load PGN</button>
  <button id="flipBtn">Flip Board</button>
  <button id="exportPgnBtn">Export PGN</button>

  <div id="boardContainer">
    <div id="board"></div>
    <canvas id="overlayCanvas"></canvas>
  </div>

  <div>
    <button id="prevMove">◀ Prev</button>
    <button id="nextMove">Next ▶</button>
    <input type="range" id="moveSlider" min="0" value="0" style="width:200px;">
    <span id="moveCounter">0/0</span>
  </div>

  <h4>Comment</h4>
  <textarea id="commentBox"></textarea>
  <button id="saveComment">Save</button>
  <button id="clearComment">Clear</button>

  <h4>Arrows</h4>
  <button id="arrowModeBtn">Arrow Mode</button>
  <input type="color" id="arrowColor" value="#ff0000">
  <button id="clearArrowsBtn">Clear Arrows</button>

</div>

<div id="right">
  <h3>Moves</h3>
  <div id="moveList" style="max-height:500px;overflow:auto;border:1px solid #ccc;padding:5px;"></div>

  <h3>Session</h3>
  <button id="saveSession">Save Session</button>
  <button id="loadSession">Load Session</button>
  <button id="clearSession">Clear Session</button>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/js/chessboard.min.js"></script>

<script>
/* ===================== GLOBAL STATE ===================== */
let game = new Chess();
let board = Chessboard("board", { draggable:false });
let moves = [];
let currentMove = 0;
let arrowMode = false;
let arrowStage = null;

/* canvas */
const canvas = document.getElementById("overlayCanvas");
const ctx = canvas.getContext("2d");

/* ===================== UPLOAD ===================== */
document.getElementById("dropZone").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = () => {
  let file = document.getElementById("fileInput").files[0];
  if (!file) return;

  let reader = new FileReader();
  reader.onload = () => { document.getElementById("pgnInput").value = reader.result; };
  reader.readAsText(file);
};

/* ===================== LOAD PGN ===================== */
function normalizePGN(pgn){
  return pgn.replace(/\r/g,"").replace(/\n\n+/g,"\n\n");
}

function loadPGN(pgnText){
  pgnText = normalizePGN(pgnText);

  game.reset();
  moves = [];
  currentMove = 0;

  if (!game.load_pgn(pgnText,{sloppy:true})) {
    alert("Invalid PGN");
    return;
  }

  const history = game.history({verbose:true});
  const comments = [...pgnText.matchAll(/\{([^}]*)}/g)].map(a=>a[1]);

  let tmp = new Chess();
  let ci = 0;

  history.forEach(m=>{
    tmp.move(m.san);
    moves.push({
      san:m.san,
      fen:tmp.fen(),
      comment:comments[ci]||"",
      arrows:[]
    });
    ci++;
  });

  updateMoveList();
  updateBoard();
}

document.getElementById("loadPgn").onclick = () => {
  loadPGN(document.getElementById("pgnInput").value);
};

/* ===================== MOVE LIST ===================== */
function updateMoveList(){
  let list = document.getElementById("moveList");
  list.innerHTML = "";

  moves.forEach((m,i)=>{
    let row = document.createElement("div");
    row.className = "move-row";
    row.textContent = `${i+1}. ${m.san}`;
    row.dataset.i = i;

    row.onclick = () => {
      currentMove = i+1;
      updateBoard();
    };

    list.appendChild(row);
  });
}

/* ===================== BOARD UPDATE ===================== */
function updateBoard(){
  if (currentMove === 0) board.position("start");
  else board.position(moves[currentMove-1].fen);

  document.getElementById("moveCounter").textContent =
    `${currentMove}/${moves.length}`;

  document.getElementById("moveSlider").max = moves.length;
  document.getElementById("moveSlider").value = currentMove;

  document.getElementById("commentBox").value =
    currentMove ? moves[currentMove-1].comment : "";

  renderArrows();
}

/* ===================== NAVIGATION ===================== */
document.getElementById("nextMove").onclick = ()=>{
  if (currentMove < moves.length) currentMove++;
  updateBoard();
};

document.getElementById("prevMove").onclick = ()=>{
  if (currentMove > 0) currentMove--;
  updateBoard();
};

document.getElementById("moveSlider").oninput = (e)=>{
  currentMove = Number(e.target.value);
  updateBoard();
};

/* ===================== COMMENTS ===================== */
document.getElementById("saveComment").onclick = ()=>{
  if (!currentMove) return;
  moves[currentMove-1].comment = document.getElementById("commentBox").value;
  updateMoveList();
};

document.getElementById("clearComment").onclick = ()=>{
  if (!currentMove) return;
  moves[currentMove-1].comment = "";
  document.getElementById("commentBox").value = "";
  updateMoveList();
};

/* ===================== ARROWS ===================== */
document.getElementById("arrowModeBtn").onclick = ()=>{
  arrowMode = !arrowMode;
  arrowStage = null;
  alert("Arrow mode: " + (arrowMode?"ON":"OFF"));
};

function squareFromElement(el){
  for (let c of el.classList)
    if (c.startsWith("square-"))
      return c.replace("square-","");
  return null;
}

document.getElementById("board").addEventListener("click",(e)=>{
  if (!arrowMode || !currentMove) return;

  let sq = squareFromElement(e.target);
  if (!sq) return;

  if (!arrowStage) {
    arrowStage = sq;
    return;
  }

  moves[currentMove-1].arrows.push({
    from: arrowStage,
    to: sq,
    color: document.getElementById("arrowColor").value
  });

  arrowStage = null;
  renderArrows();
});

document.getElementById("clearArrowsBtn").onclick = ()=>{
  if (!currentMove) return;
  moves[currentMove-1].arrows = [];
  renderArrows();
};

/* ===================== DRAW ARROWS ===================== */
function resizeCanvas(){
  const rect = document.getElementById("board").getBoundingClientRect();

  canvas.width = rect.width * devicePixelRatio;
  canvas.height = rect.height * devicePixelRatio;
  canvas.style.width = rect.width + "px";
  canvas.style.height = rect.height + "px";

  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}

function squareCenter(sq){
  const rect = document.getElementById("board").getBoundingClientRect();
  const size = rect.width / 8;

  const file = sq.charCodeAt(0) - 97;
  const rank = 8 - parseInt(sq[1]);

  return {
    x: file * size + size/2,
    y: rank * size + size/2
  };
}

function drawArrow(a){
  const p1 = squareCenter(a.from);
  const p2 = squareCenter(a.to);

  ctx.strokeStyle = a.color;
  ctx.fillStyle = a.color;
  ctx.lineWidth = 6;

  ctx.beginPath();
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p2.x,p2.y);
  ctx.stroke();

  const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
  const head = 15;

  ctx.beginPath();
  ctx.moveTo(p2.x,p2.y);
  ctx.lineTo(p2.x - head*Math.cos(angle-0.5),
             p2.y - head*Math.sin(angle-0.5));
  ctx.lineTo(p2.x - head*Math.cos(angle+0.5),
             p2.y - head*Math.sin(angle+0.5));
  ctx.closePath();
  ctx.fill();
}

function renderArrows(){
  resizeCanvas();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (!currentMove) return;

  moves[currentMove-1].arrows.forEach(a => drawArrow(a));
}

/* ===================== EXPORT ===================== */
document.getElementById("exportPgnBtn").onclick = ()=>{
  let out = "";
  let num = 1;

  for (let i=0;i<moves.length;i++){
    if (i%2===0) out += num++ + ". ";
    out += moves[i].san;

    if (moves[i].comment)
      out += " {" + moves[i].comment + "}";

    out += " ";
  }

  const w = window.open("", "_blank");
  w.document.write("<pre>"+out+"</pre>");
};

/* ===================== SESSION ===================== */
document.getElementById("saveSession").onclick=()=>{
  localStorage.setItem("pgn_session",JSON.stringify({moves,currentMove}));
  alert("Saved!");
};

document.getElementById("loadSession").onclick=()=>{
  let d = JSON.parse(localStorage.getItem("pgn_session")||"{}");
  if (!d.moves) return alert("No session stored");

  moves = d.moves;
  currentMove = d.currentMove;
  updateMoveList();
  updateBoard();
};

document.getElementById("clearSession").onclick=()=>{
  localStorage.removeItem("pgn_session");
  alert("Cleared!");
};

</script>
</body>
</html>
