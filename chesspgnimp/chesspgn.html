\<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Advanced PGN Chess Viewer — Arrows & Annotations</title>

  <!-- chessboard.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/css/chessboard.min.css"/>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent: #1572A1;
      --muted: #666;
      --bg: #f7fbff;
      --panel-bg: #ffffff;
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      padding:16px;
      background: linear-gradient(180deg, #f3f9ff, #ffffff);
      color:#0b1720;
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 18px;
      max-width: 1200px;
      margin: 0 auto;
      align-items: start;
    }
    @media (max-width: 980px){
      .app { grid-template-columns: 1fr; }
      .sidebar { order: 2; }
    }

    #dropZone {
      border: 2px dashed var(--accent);
      border-radius: 10px;
      padding: 16px;
      text-align:center;
      background: #f2fbff;
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
    }
    #dropZone:hover {
      background:#e8f7ff;
    }

    .left { display:flex; flex-direction:column; gap:12px; }

    .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    button, select, input[type="color"] {
      background: var(--panel-bg);
      border: 1px solid #d6e6f2;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { transform: translateY(-1px); }

    #boardContainer { background: var(--panel-bg); border-radius: 12px; padding: 12px; box-shadow: 0 6px 20px rgba(8,30,45,0.06); position: relative; }
    #board { width: 420px; max-width: 90vw; }
    #overlayCanvas { position: absolute; left: 12px; top: 12px; pointer-events: none; }

    #comments { width: 420px; max-width:90vw; min-height:64px; background:#fcfeff; padding:10px; border-radius:8px; border:1px solid #e6f0f6; }

    textarea#commentBox { width:100%; min-height:72px; border-radius:6px; padding:8px; border:1px solid #e6eef2; }

    .sidebar { background: var(--panel-bg); border-radius: 12px; padding: 12px; box-shadow: 0 6px 20px rgba(8,30,45,0.06); height: fit-content; }
    .move-list { max-height: 540px; overflow: auto; padding:8px; border-radius:8px; border: 1px solid #eef6fb; }
    .move-row { padding:6px 8px; display:flex; gap:8px; align-items:center; justify-content:space-between; border-radius:6px; cursor:pointer; }
    .move-row:hover { background:#f1fbff; }
    .move-row.active { background: linear-gradient(90deg,#eaf6ff,#f8fbff); border-left:4px solid var(--accent); }

    .small { font-size:13px; color:var(--muted); }
    .muted { color:var(--muted); }

    .tools { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .annotation-list { max-height:160px; overflow:auto; border-radius:6px; border:1px solid #eef6fb; padding:8px; }

  </style>
</head>
<body>
  <div class="app">
    <div class="left">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0">PGN Viewer — Arrows & Annotations</h2>
          <div class="small muted">Add arrows and per-move annotations. Export PGN with comments.</div>
        </div>
        <div class="small muted" id="engineStatus">Engine: integrated</div>
      </div>

      <!-- CLICK TO UPLOAD -->
      <div id="dropZone">
        Click to upload a <strong>.pgn</strong> file
        <input type="file" id="fileInput" accept=".pgn" style="display:none">
      </div>

      <textarea id="pgnInput" placeholder="Paste PGN here (or upload above)"></textarea>

      <div class="controls">
        <button id="loadPgn">Load PGN</button>
        <button id="flipBtn">Flip Board</button>
        <button id="exportPgnBtn" class="export-btn">Export PGN (with comments)</button>
      </div>

      <div id="boardContainer">
        <div id="board"></div>
        <canvas id="overlayCanvas"></canvas>

        <div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button id="prevMove">◀ Prev</button>
          <button id="nextMove">Next ▶</button>
          <input type="range" id="moveSlider" min="0" max="0" value="0" style="width:220px">
          <div id="moveCounter" class="small muted">0 / 0</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
          <div style="width:260px">
            <div class="small muted">Comment for current move</div>
            <textarea id="commentBox" placeholder="Edit comment here..."></textarea>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="saveComment">Save Comment</button>
              <button id="clearComment">Clear Comment</button>
            </div>
          </div>

          <div style="width:140px">
            <div class="small muted">Arrow tools</div>
            <div class="tools">
              <button id="arrowModeBtn">Arrow Mode</button>
              <input id="arrowColor" type="color" value="#ff0000">
              <button id="clearArrowsBtn">Clear Arrows</button>
            </div>

            <div style="margin-top:8px">
              <div class="small muted">Arrows on this move</div>
              <div id="annotationArrows" class="annotation-list"></div>
            </div>
          </div>
        </div>

        <div id="comments" style="margin-top:12px">No comments yet.</div>
      </div>

    </div>

    <aside class="sidebar">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;font-size:16px">Moves</h3>
        <div class="small muted">Click to jump</div>
      </div>

      <div class="move-list" id="moveList"></div>

      <hr style="margin:12px 0;border-color:#eef6fb">

      <div>
        <div class="small muted">Session actions</div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <button id="saveSession">Save to localStorage</button>
          <button id="loadSession">Load from localStorage</button>
          <button id="clearSession">Clear session</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/js/chessboard.min.js"></script>

  <script>
  /******************************
   CLICK UPLOAD INSTEAD OF DRAG
  ******************************/
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");

  dropZone.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith(".pgn")) {
      alert("Please upload a .pgn file");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => (pgnInput.value = reader.result);
    reader.readAsText(file);
  });

  /******************************
    REST OF YOUR ORIGINAL SCRIPT
  ******************************/
  /* (UNCHANGED full JavaScript logic here — arrows, board, comments, export, etc.) */

  /* ——— To save space, not repeating the entire JS here unless you want the WHOLE THING pasted again.  
        If you want the FULL SCRIPT including arrows/comment code re-pasted, say "full JS also". ——— */

  </script>

</body>
</html>
