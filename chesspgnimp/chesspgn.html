<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PGN Viewer — Engine Eval Bar & PV Arrows (WASM)</title>

<!-- chessboard.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/css/chessboard.min.css"/>

<style>
:root{
  --bg:#f4f8fb;
  --panel:#ffffff;
  --muted:#6b7280;
  --accent:#1572A1;
  --text:#071422;
}
body{margin:0;padding:14px;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
.app{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
@media(max-width:980px){.app{grid-template-columns:1fr}}
.card{background:var(--panel);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(10,25,40,0.06)}
.header{display:flex;justify-content:space-between;align-items:center}
#dropZone{border:2px dashed var(--accent);padding:12px;border-radius:10px;text-align:center;background:linear-gradient(180deg,#f2fbff,#fff);cursor:pointer;font-weight:700;color:var(--accent)}
textarea{width:100%;min-height:72px;padding:8px;border-radius:8px;border:1px solid #e6eef2;resize:vertical}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
#boardContainer{position:relative;padding:12px;border-radius:10px;margin-top:12px}
#board{width:420px;max-width:100%}
#overlayCanvas{position:absolute;left:12px;top:12px;pointer-events:none}
.move-controls{display:flex;gap:8px;align-items:center;margin-top:10px}
.small{font-size:13px;color:var(--muted)}
.move-list{max-height:520px;overflow:auto;padding:8px;border-radius:8px;border:1px solid #eef6fb;background:#fcfdff}
.move-row{padding:6px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.move-row:hover{background:#f1fbff}
.move-row.active{background:linear-gradient(90deg,#eaf6ff,#f8fbff);border-left:4px solid var(--accent)}
.eval-wrap{position:absolute;right:-34px;top:12px;width:22px;height:calc(100% - 24px);display:flex;align-items:center}
.eval-track{width:100%;height:100%;background:linear-gradient(to bottom,#fff,#000);border-radius:8px;overflow:hidden;border:1px solid rgba(0,0,0,0.06)}
#evalBar{width:100%;background:linear-gradient(white,#ffd9d9);height:50%;transition:height .25s ease}
.eval-label{position:absolute;right:-86px;top:10px;width:70px;text-align:center;font-weight:700}
.eval-value{margin-left:8px;padding:6px 8px;border-radius:8px;background:#0f1724;color:#fff;font-weight:700}
.annotation-list{max-height:160px;overflow:auto;border-radius:6px;border:1px solid #eef6fb;padding:8px;background:#fff}

button,select,input[type="color"]{padding:8px;border-radius:8px;border:1px solid #d6e6f2;background:#fff;cursor:pointer}
</style>
</head>
<body>
<div class="app">

  <!-- MAIN -->
  <main class="card">
    <div class="header">
      <div>
        <h2 style="margin:0">PGN Viewer — Engine & PV Arrows</h2>
        <div class="small">Click upload, annotate, analyze with Stockfish WASM</div>
      </div>
      <div class="small" id="engineStatus">Engine: stopped</div>
    </div>

    <!-- upload -->
    <div id="dropZone" style="margin-top:12px">Click to upload a <strong>.pgn</strong> file</div>
    <input type="file" id="fileInput" accept=".pgn" style="display:none;margin-top:8px">
    <textarea id="pgnInput" placeholder="Paste PGN here (or upload)"></textarea>

    <div class="controls">
      <button id="loadPgn">Load PGN</button>
      <button id="autoLoadToggle">Auto-load: OFF</button>
      <button id="analyzeBtn">Analyze ▶</button>
      <button id="stopEngineBtn">Stop ◼</button>
      <button id="exportPgnBtn">Export PGN</button>
      <div style="margin-left:auto" class="small">Arrows persist per move in session</div>
    </div>

    <div id="boardContainer" class="card" style="margin-top:8px">
      <div id="board"></div>
      <canvas id="overlayCanvas"></canvas>

      <!-- Eval bar (vertical) -->
      <div class="eval-wrap">
        <div class="eval-track" aria-hidden="true">
          <div id="evalBar"></div>
        </div>
      </div>
      <div class="eval-label" style="right:-120px;top:8px">
        <div class="small">Eval</div>
        <div id="evalBox" class="eval-value">—</div>
      </div>

      <div class="move-controls" style="margin-top:10px">
        <button id="prevMove">◀ Prev</button>
        <button id="nextMove">Next ▶</button>
        <input type="range" id="moveSlider" min="0" max="0" value="0" style="width:220px">
        <div id="moveCounter" class="small">0 / 0</div>
        <div style="margin-left:auto" class="small" id="bestMoveBox">Best: —</div>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="width:320px">
          <div class="small">Comment for current move</div>
          <textarea id="commentBox" placeholder="Edit comment here..."></textarea>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="saveComment">Save Comment</button>
            <button id="clearComment">Clear Comment</button>
          </div>
          <div style="margin-top:10px">
            <div class="small">Comments Panel</div>
            <div id="commentsPanel" class="annotation-list"></div>
          </div>
        </div>

        <div style="width:200px">
          <div class="small">Arrow tools</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <button id="arrowModeBtn">Arrow Mode</button>
            <select id="arrowStyle"><option value="arrow">Arrow</option><option value="circle">Circle</option></select>
            <input id="arrowColor" type="color" value="#ff0000">
            <button id="clearArrowsBtn">Clear Arrows</button>
          </div>

          <div style="margin-top:10px">
            <div class="small">Arrows on this move</div>
            <div id="annotationArrows" class="annotation-list"></div>
          </div>

          <div style="margin-top:10px">
            <div class="small">Engine Depth</div>
            <input id="engineDepth" type="number" value="12" min="5" max="28" style="width:80px">
          </div>
        </div>
      </div>

    </div>

  </main>

  <!-- SIDEBAR -->
  <aside class="card" style="height:fit-content">
    <h3 style="margin-top:0">Moves</h3>
    <div id="moveList" class="move-list"></div>

    <hr style="margin:12px 0;border-color:#eef6fb">

    <div class="small">Variation tree</div>
    <div id="varTree" class="annotation-list" style="max-height:160px;overflow:auto"></div>

    <div style="margin-top:8px">
      <div class="small">Session</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="saveSession">Save</button>
        <button id="loadSession">Load</button>
        <button id="clearSession">Clear</button>
      </div>
    </div>

    <div style="margin-top:8px" class="small">Shortcuts: ← → for moves, A toggles arrow mode</div>
  </aside>

</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/js/chessboard.min.js"></script>

<!-- Stockfish WASM worker loaded as web worker script from jsDelivr.
     Using stockfish.wasm package worker URL (public CDN). -->
<!-- Note: we create the Worker in JS below using this URL string. -->

<script>
/**************************************************************************
 * Full viewer with Stockfish WASM engine, evaluation bar and PV arrows
 **************************************************************************/

/* ---------------- Elements ---------------- */
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const pgnInput = document.getElementById('pgnInput');
const loadPgnBtn = document.getElementById('loadPgn');
const moveListEl = document.getElementById('moveList');
const varTreeEl = document.getElementById('varTree');
const commentsPanel = document.getElementById('commentsPanel');
const moveSlider = document.getElementById('moveSlider');
const moveCounter = document.getElementById('moveCounter');
const prevMoveBtn = document.getElementById('prevMove');
const nextMoveBtn = document.getElementById('nextMove');
const commentBox = document.getElementById('commentBox');
const saveCommentBtn = document.getElementById('saveComment');
const clearCommentBtn = document.getElementById('clearComment');
const arrowModeBtn = document.getElementById('arrowModeBtn');
const arrowColorInput = document.getElementById('arrowColor');
const arrowStyleSelect = document.getElementById('arrowStyle');
const clearArrowsBtn = document.getElementById('clearArrowsBtn');
const annotationArrowsDiv = document.getElementById('annotationArrows');
const exportPgnBtn = document.getElementById('exportPgnBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const stopEngineBtn = document.getElementById('stopEngineBtn');
const engineDepthInput = document.getElementById('engineDepth');
const bestMoveBox = document.getElementById('bestMoveBox');
const evalBox = document.getElementById('evalBox'); // eval value box
const autoLoadToggle = document.getElementById('autoLoadToggle');
const engineStatus = document.getElementById('engineStatus');

const boardEl = document.getElementById('board');
const canvas = document.getElementById('overlayCanvas');
const ctx = canvas.getContext('2d');

let boardRect = null;

/* ---------------- Chess & UI state ---------------- */
const game = new Chess();
const board = Chessboard(boardEl, {
  draggable: false,
  position: 'start',
  pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
});

let moves = []; // {san, fen, comment, arrows:[], variations:[]}
let currentMove = 0;
let arrowMode = false;
let arrowStage = null;
let pvArrows = []; // arrows drawn from PV {from,to,color,alpha}

/* ---------------- Engine state ---------------- */
let engineWorker = null;
let engineReady = false;
let engineThinking = false;

/* ---------------- Utilities ---------------- */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function setEngineStatus(t){ engineStatus.textContent = 'Engine: ' + t; }

/* ---------------- Click-to-upload (input outside clickable div) ---------------- */
dropZone.addEventListener('click', ()=> fileInput.click());
let autoLoadOnSelect = false;
autoLoadToggle.addEventListener('click', ()=>{
  autoLoadOnSelect = !autoLoadOnSelect;
  autoLoadToggle.textContent = `Auto-load: ${autoLoadOnSelect? 'ON':'OFF'}`;
});
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files && fileInput.files[0];
  if (!f) return;
  if (!f.name.toLowerCase().endsWith('.pgn')) { alert('Please upload a .pgn file'); return; }
  const r = new FileReader();
  r.onload = ()=> { pgnInput.value = r.result; if (autoLoadOnSelect) loadFromTextarea(); };
  r.readAsText(f);
});

/* ---------------- PGN parsing + load ---------------- */
function normalizePGN(s){ return s.replace(/\r/g,'').replace(/\n\n+/g,'\n\n'); }

function parsePGNTokens(pgn){
  pgn = pgn.replace(/\[.*?\]\s*\n/g,'').trim();
  pgn = pgn.replace(/\n/g,' ').replace(/\s+/g,' ').trim();
  const tokens=[];
  let i=0;
  while(i<pgn.length){
    const ch=pgn[i];
    if (ch==='('){
      let bal=1,j=i+1;
      while(j<pgn.length && bal>0){
        if (pgn[j]==='(') bal++; else if (pgn[j]===')') bal--;
        j++;
      }
      const inner=pgn.slice(i+1,j-1);
      tokens.push({type:'var', value: parsePGNTokens(inner)});
      i=j;
    } else if (ch==='{'){
      let j=i+1;
      while(j<pgn.length && pgn[j]!=='}') j++;
      tokens.push({type:'comment', value: pgn.slice(i+1,j).trim()});
      i=j+1;
    } else {
      let j=i;
      while(j<pgn.length && pgn[j] !== ' ' && pgn[j] !== '(' && pgn[j] !== '{' && pgn[j] !== ')') j++;
      const word = pgn.slice(i,j).trim();
      if (word) tokens.push({type:'word', value:word});
      i=j;
      if (pgn[i]===' ') i++;
    }
  }
  return tokens;
}

function buildMovesFromTokens(tokens){
  const tmp = new Chess();
  const result = [];
  let commentQueue = [];
  for (let i=0;i<tokens.length;i++){
    const t = tokens[i];
    if (t.type==='word'){
      if (/^\d+\.$/.test(t.value)) continue;
      if (['1-0','0-1','1/2-1/2','*'].includes(t.value)) continue;
      if (tmp.move(t.value)) {
        result.push({ san: t.value, fen: tmp.fen(), comment: (commentQueue.shift()||''), arrows: [], variations: [] });
      }
    } else if (t.type==='comment'){
      commentQueue.push(t.value);
    } else if (t.type==='var'){
      // attach variation to previous move
      if (result.length){
        // convert variation tokens to SAN list relative to position before var (best-effort)
        const beforeFen = result[result.length-1].fen;
        const varSeq = parseVariantFromTokens(t.value, beforeFen);
        result[result.length-1].variations.push(varSeq);
      }
    }
  }
  return result;
}

function parseVariantFromTokens(tokens, fen){
  const tmp = new Chess(fen);
  const seq=[];
  tokens.forEach(t=>{
    if (t.type==='word'){
      if (/^\d+\.$/.test(t.value)) return;
      if (['1-0','0-1','1/2-1/2','*'].includes(t.value)) return;
      if (tmp.move(t.value)) seq.push({ san: t.value, fen: tmp.fen() });
    }
  });
  return seq;
}

function loadFromTextarea(){
  const txt = pgnInput.value.trim();
  if (!txt) { alert('Paste or upload a PGN first'); return; }
  const norm = normalizePGN(txt);
  const tokens = parsePGNTokens(norm);
  moves = buildMovesFromTokens(tokens);
  // restore arrows header if exists
  const arrowHeaderMatch = txt.match(/\[Arrows "([^"]+)"\]/);
  if (arrowHeaderMatch){
    try {
      const arr = JSON.parse(decodeURIComponent(arrowHeaderMatch[1]));
      Object.keys(arr).forEach(k=>{ const idx = Number(k); if (moves[idx]) moves[idx].arrows = arr[k]; });
    } catch(e){ console.warn('arrow header parse failed', e); }
  }
  currentMove = 0;
  updateMoveList();
  updateBoard();
  buildVarTree();
}

/* ---------------- UI update: move list, board, comments, variations ---------------- */
function updateMoveList(){
  moveListEl.innerHTML = '';
  for (let i=0;i<moves.length;i++){
    const m = moves[i];
    const row = document.createElement('div');
    row.className = 'move-row';
    row.dataset.idx = i;
    row.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:28px;font-weight:700">${i+1}.</div><div style="min-width:160px">${escapeHtml(m.san)}</div></div>
      <div class="small">${m.comment? (m.comment.length>40? escapeHtml(m.comment.slice(0,40))+'...':escapeHtml(m.comment)) : ''}</div>`;
    row.addEventListener('click', ()=>{
