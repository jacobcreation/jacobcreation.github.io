<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline PGN Viewer (Unicode Board)</title>
<style>
  body { font-family: monospace; padding: 20px; }
  #board { line-height: 1.5; margin-bottom: 20px; white-space: pre; }
  #moves { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
  input, button { margin: 5px; }
</style>
</head>
<body>
<h1>Offline PGN Viewer (Unicode Board)</h1>
<input type="file" id="pgnFile" accept=".pgn"><br>
<button id="prevMove">◀ Previous</button>
<button id="nextMove">Next ▶</button>
<div id="board"></div>
<div id="moves"></div>

<!-- Load chess.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
<script>
// Unicode mapping
const unicodePieces = {
  'r':'♜','n':'♞','b':'♝','q':'♛','k':'♚','p':'♟',
  'R':'♖','N':'♘','B':'♗','Q':'♕','K':'♔','P':'♙',
  '':' '
};

// Convert FEN to 2D board array
function fenToBoard(fen) {
  const rows = fen.split(' ')[0].split('/');
  const boardArr = [];
  for (let r=0; r<8; r++) {
    const row = [];
    for (const ch of rows[r]) {
      if (isNaN(ch)) row.push(ch);
      else for (let i=0; i<parseInt(ch); i++) row.push('');
    }
    boardArr.push(row);
  }
  return boardArr;
}

// Draw board in Unicode
function drawBoard(boardArr){
  let str = '  a b c d e f g h\n';
  for(let r=0;r<8;r++){
    str += (8-r) + ' ';
    for(let f=0;f<8;f++){
      str += unicodePieces[boardArr[r][f]] + ' ';
    }
    str += (8-r) + '\n';
  }
  str += '  a b c d e f g h\n';
  document.getElementById('board').textContent = str;
}

// Display moves with comments
function displayMovesWithComments(pgn) {
  const movesDiv = document.getElementById('moves');
  const cleanPGN = pgn.replace(/\r?\n/g, ' ');
  const regex = /(\d+\.)\s*([^\s{]+)(\s*([^\s{]+))?\s*(\{[^}]+\})?/g;
  let result;
  let output = '';
  while ((result = regex.exec(cleanPGN)) !== null) {
    const moveNumber = result[1];
    const whiteMove = result[2];
    const blackMove = result[4] || '';
    const comment = result[5] || '';
    output += `${moveNumber} ${whiteMove} ${blackMove} ${comment}\n`;
  }
  movesDiv.textContent = output;
}

// Game state
let game = new Chess();
let moves = [];
let currentIndex = 0;

// Show current board
function showBoard() {
  drawBoard(fenToBoard(game.fen()));
}

// Step forward
function nextMove() {
  if (currentIndex < moves.length) {
    game.move(moves[currentIndex]);
    currentIndex++;
    showBoard();
  }
}

// Step backward (rebuild from start)
function prevMove() {
  if (currentIndex > 0) {
    currentIndex--;
    game = new Chess();
    for (let i=0; i<currentIndex; i++) {
      game.move(moves[i]);
    }
    showBoard();
  }
}

// Load PGN file
document.getElementById('pgnFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    const pgnText = event.target.result;
    game = new Chess();
    game.load_pgn(pgnText);
    moves = game.history(); // SAN moves
    currentIndex = 0;
    game = new Chess(); // reset to start
    showBoard();
    displayMovesWithComments(pgnText);
  };
  reader.readAsText(file);
});

// Button events
document.getElementById('nextMove').addEventListener('click', nextMove);
document.getElementById('prevMove').addEventListener('click', prevMove);

// Show initial position
showBoard();
</script>
</body>
</html>
